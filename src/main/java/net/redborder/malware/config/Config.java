package net.redborder.malware.config;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Arrays;
import java.util.Date;
import java.util.List;
import java.util.Properties;
import java.util.concurrent.TimeUnit;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class Config{

    final Logger log = LoggerFactory.getLogger(Config.class);

    private static Properties createdConfigure = new Properties();

    private Properties config;

    private String FILE_CONF = "config.properties";

    public Config(){
        reload();
    }

    public Config(String path){
        FILE_CONF = path;
        reload();
    }

    public Config(Properties prop){
        config = prop;
    }

    public void reload(){

        config = new Properties();

        try {
            config.load(new InputStreamReader(new FileInputStream(FILE_CONF)));
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    public String get(String k, String defaultString) {
        return !config.containsKey(k) ? defaultString : String.valueOf(config.get(k));
    }

    public static void add(String k, String value){
        createdConfigure.setProperty(k, value);
    }

    public String get(String k) throws ConfigException {
        if(config.containsKey(k)) {
            return String.valueOf(config.get(k));
        } else {
            throw new ConfigException("Missing key " + k + ".");
        }
    }

    public long getTime(String k, String time){

        if(config.containsKey(k)){
            return  parseTime(config.get(k).toString());
        }

        return parseTime(time);
    }

    public long getTime(String k){
            return  parseTime(config.get(k).toString());
    }

    public static void addTime(String k, String time){
        createdConfigure.put(k, time);
    }

    public List<String> getList(String k, List<String> defaultValue){
        if(!config.containsKey(k)){
            return defaultValue;
        }else{
            String value = String.valueOf(config.get(k));
            String [] pieces = value.split("\\s*,\\s*");

            for(int i = 0 ; i < pieces.length; i++)
                pieces[i] = pieces[i].trim();

            return Arrays.asList(pieces);
        }
    }

    public List<String> getList(String k) throws ConfigException {
        if(!config.containsKey(k)) {
            throw new ConfigException("Missing key " + k + ".");
        } else {
            return this.getList(k, (List) null);
        }
    }

    public static void addList(String k, String list){
        createdConfigure.setProperty(k, list);
    }

    public boolean getBoolean(String k, boolean defaultValue) {
        return config.containsKey(k) ? "true".equalsIgnoreCase(String.valueOf(config.get(k))) : defaultValue;
    }

    public static void clearConfiguration(){
        createdConfigure.clear();
    }

    public static void addBoolean(String k, boolean value){
        createdConfigure.setProperty(k, String.valueOf(value));
    }

    public boolean getBoolean(String k) throws ConfigException {
        if(config.containsKey(k)) {
            return "true".equalsIgnoreCase(String.valueOf(config.get(k)));
        } else {
            throw new ConfigException("Missing key " + k + ".");
        }
    }

    public static void addShort(String k, short value){
        createdConfigure.setProperty(k, String.valueOf(value));
    }

    public short getShort(String k, short defaultValue) {
        return config.containsKey(k) ? Short.parseShort(String.valueOf(config.get(k))) : defaultValue;
    }

    public short getShort(String k) throws ConfigException {
        if(config.containsKey(k)) {
            return Short.parseShort(String.valueOf(config.get(k)));
        } else {
            throw new ConfigException("Missing key " + k + ".");
        }
    }

    public static void addLong(String k, long value){
        createdConfigure.setProperty(k, String.valueOf(value));
    }

    public long getLong(String k, long defaultValue) {
        return config.containsKey(k) ? Long.parseLong(String.valueOf(config.get(k))) : defaultValue;
    }

    public long getLong(String k) throws ConfigException {
        if(config.containsKey(k)) {
            return Long.parseLong(String.valueOf(config.get(k)));
        } else {
            throw new ConfigException("Missing key " + k + ".");
        }
    }

    public static void addInt(String k, int value){
        createdConfigure.setProperty(k, String.valueOf(value));
    }

    public int getInt(String k, int defaultValue) {
        return config.containsKey(k) ? Integer.parseInt(String.valueOf(config.get(k))) : defaultValue;
    }

    public int getInt(String k) throws ConfigException {
        if(config.containsKey(k)) {
            return Integer.parseInt(String.valueOf(config.get(k)));
        } else {
            throw new ConfigException("Missing key " + k + ".");
        }
    }

    public static void addDouble(String k, double value){
        createdConfigure.setProperty(k, String.valueOf(value));
    }

    public double getDouble(String k, double defaultValue) {
        return config.containsKey(k) ? Double.parseDouble(String.valueOf(config.get(k))) : defaultValue;
    }

    public double getDouble(String k) throws ConfigException {
        if(config.containsKey(k)) {
            return Double.parseDouble(String.valueOf(config.get(k)));
        } else {
            throw new ConfigException("Missing key " + k + ".");
        }
    }

    public static void addClass(String k, String value){
        createdConfigure.setProperty(k, value);
    }

    public <T> Class<?> getClass(String k) throws ConfigException {
        if(config.containsKey(k)) {
            try {
                return Class.forName(String.valueOf(config.get(k)));
            } catch (Exception var3) {
                throw new ConfigException("Unable to find class.");
            }
        } else {
            throw new ConfigException("Missing key " + k + ".");
        }
    }

    public <T> Object getNewInstance(String k) throws ConfigException {

        if(config.containsKey(k)){

            try {
                return Class.forName(String.valueOf(config.get(k))).newInstance();
            } catch (Exception var3) {
                throw new ConfigException("Unable to find class.");
            }

        }else{
            throw new ConfigException("Unable to instantiate class.");
        }

    }

    public static void addDate(String k, Date value){
        createdConfigure.setProperty(k, value.toString());
    }

    public Date getDate(String k) throws ConfigException {
        return this.getDate(k, new SimpleDateFormat());
    }

    public Date getDate(String k, String format) throws ConfigException {
        return this.getDate(k, new SimpleDateFormat(format));
    }

    public Date getDate(String k, SimpleDateFormat format) throws ConfigException {
        if(!config.contains(k)) {
            throw new ConfigException("Missing key " + k + ".");
        } else {
            try {
                return format.parse((String)this.get(k));
            } catch (ParseException var4) {
                throw new ConfigException("Date format exception.");
            }
        }
    }

    public Date getDate(String k, Date defaultValue) throws ConfigException {
        return this.getDate(k, new SimpleDateFormat(), defaultValue);
    }

    public Date getDate(String k, String format, Date defaultValue) throws ConfigException {
        return this.getDate(k, new SimpleDateFormat(format), defaultValue);
    }

    public Date getDate(String k, SimpleDateFormat format, Date defaultValue) throws ConfigException {
        if(!config.containsKey(k)) {
            return defaultValue;
        } else {
            try {
                return format.parse((String)this.get(k));
            } catch (ParseException var5) {
                throw new ConfigException("Date format exception.");
            }
        }
    }

    public static Config createConfig(){
        return new Config(createdConfigure);
    }

    public Properties getProperties(){
        return config;
    }

    public long parseTime(String value){

        long time = 0;

        Pattern pattern = Pattern.compile("(?<units>\\d+)(?<time>D|H|M|S)");
        Matcher matcher = pattern.matcher(value);

        if( matcher != null && matcher.matches()){
            log.trace("Value matches!");
            log.debug("Value : {}", value);
            TimeUnit[] values = TimeUnit.values();

            for(TimeUnit tu : values)
                if(tu.toString().startsWith(matcher.group("time")) && !tu.toString().matches("(?:MICROSECONDS|MILLISECONDS)")) {

                    time = tu.toMillis(Long.valueOf(matcher.group("units")));
                    break;
                }
        }

        return time;
    }

}
