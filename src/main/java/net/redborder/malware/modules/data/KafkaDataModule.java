package net.redborder.malware.modules.data;

import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import kafka.consumer.Consumer;
import kafka.consumer.ConsumerConfig;
import kafka.consumer.ConsumerIterator;
import kafka.consumer.KafkaStream;
import kafka.javaapi.consumer.ConsumerConnector;
import net.redborder.malware.config.Config;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.*;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

public class KafkaDataModule extends AbstractDataModule{

    private static final Logger log = LoggerFactory.getLogger(KafkaDataModule.class);

    private ConsumerConnector consumerConnector;

    private LinkedList<Map<String, Object>> incrementalList;

    private int lastIndex = 0;

    private ExecutorService consumerThread;

    public KafkaDataModule(Config conf){
        super(conf);
    }

    @Override
    public Object getFullDataImpl() {
        finalResult = new ArrayList<Map<String, Object>>();
        return finalResult;
    }

    @Override
    public Object getIncrementalImpl() {

        lastIndex = incrementalList.size();
        ArrayList<Map<String, Object>> currentIncremental = (ArrayList<Map<String, Object>>) incrementalList.clone();

        incrementalList.subList(0, lastIndex).clear();

        finalResult = currentIncremental.clone();

        return finalResult;
    }

    @Override
    public void prepareQueryImpl(Object parameter) {
    // nothing
    }

    @Override
    public void initImpl() {

        log.info("Initializing Kafka data module");

        incrementalList = new LinkedList<>();
        Properties props = (Properties)config.getProperties().clone();
        props.put("group.id",UUID.randomUUID().toString());

        consumerConnector = Consumer.createJavaConsumerConnector(new ConsumerConfig(props));

        Map<String, Integer> topicCountMap = new HashMap<>();
        topicCountMap.put("rb_malware", 1);

        Map<String, List<KafkaStream<byte[], byte[]>>> consumerMap = consumerConnector.createMessageStreams(topicCountMap);
        List<KafkaStream<byte[], byte[]>> streams = consumerMap.get("rb_malware");

        consumerThread = Executors.newSingleThreadExecutor();
        consumerThread.submit(new ConsumerFromTopic(streams.get(0)));

    }

    @Override
    public void shutdownImpl() {
        log.info("Shutdown Kafka data module ...");
        consumerConnector.shutdown();
        consumerThread.shutdown();
        log.info("Done!");
    }

    @Override
    public void reloadImpl() {
        // TODO Implement if Kafka is used
    }

    @Override
    public String getDataModuleName() {
        return "Kafka";
    }

    @Override
    public Map<String, Object> processQueryURL(String URL) {
        return new HashMap<>();
    }

    @Override
    public Map<String, Object> processQueryHash(String hash) {
        return new HashMap<>();
    }

    @Override
    public Map<String, Object> processQueryIP(String IP) {
        return new HashMap<>();
    }

    private class ConsumerFromTopic implements Runnable{

        private KafkaStream a_stream;
        private ObjectMapper _mapper;

        public ConsumerFromTopic(KafkaStream m_stream){
            this.a_stream = m_stream;
            _mapper = new ObjectMapper();
        }

        @Override
        public void run() {
            ConsumerIterator<byte[], byte[]> it = a_stream.iterator();

            while(it.hasNext()) {
                try {

                    Map<String, Object> mapJson = _mapper.readValue(it.next().message(), new TypeReference<HashMap<String, Object>>() {
                    });

                    mapJson.remove("cuckoo_before");
                    mapJson.put("action", "create");

                    incrementalList.push(mapJson);

                } catch (IOException e) {
                    e.printStackTrace();
                }

            }
        }

    }
}
