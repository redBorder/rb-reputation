package net.redborder.malware.modules.data;

import net.redborder.malware.utils.IPUtils;
import com.kanishka.virustotal.dto.URL;
import com.kanishka.virustotal.dto.FileScanReport;
import com.kanishka.virustotal.dto.IPAddressReport;
import com.kanishka.virustotal.exception.APIKeyNotFoundException;
import com.kanishka.virustotal.exception.InvalidArguentsException;
import com.kanishka.virustotal.exception.QuotaExceededException;
import com.kanishka.virustotal.exception.UnauthorizedAccessException;
import com.kanishka.virustotalv2.VirusTotalConfig;
import com.kanishka.virustotalv2.VirustotalPublicV2;
import com.kanishka.virustotalv2.VirustotalPublicV2Impl;
import net.redborder.malware.config.Config;
import net.redborder.malware.config.ConfigException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Map;

public class VirusTotalDataModule extends AbstractDataModule {

    private static final Logger log = LoggerFactory.getLogger(VirusTotalDataModule.class);

    private VirustotalPublicV2 virusTotalRef;


    private String apiKey = "";

    public VirusTotalDataModule(Config conf) {
        super(conf);

    }

    @Override
    public Object getFullDataImpl() {
        finalResult = new ArrayList<Map<String, Object>>();
        return finalResult;
    }

    @Override
    public Object getIncrementalImpl() {
        finalResult = new ArrayList<Map<String, Object>>();
        return finalResult;
    }

    @Override
    public void prepareQueryImpl(Object parameter) {
        parameter.toString();
    }

    @Override
    public void initImpl() {
        log.trace("Initializing VirusTotal data module");

    }

    @Override
    public void shutdownImpl() {

    }

    @Override
    public void reloadImpl() {

        try {
            apiKey = config.get("virustotal.apikey");
            VirusTotalConfig.getConfigInstance().setVirusTotalAPIKey(apiKey);
        } catch (ConfigException e) {
            log.error(e.getLocalizedMessage());
        }

        try {
            if(!proxy.isEmpty())
                virusTotalRef = new VirustotalPublicV2Impl(proxy.get("ip").toString(), Integer.valueOf(proxy.get("port").toString()));
            else
                virusTotalRef = new VirustotalPublicV2Impl();
        } catch (APIKeyNotFoundException e) {
            log.error(e.getLocalizedMessage());
        }

    }

    @Override
    public String getDataModuleName() {
        return "VirusTotal";
    }

    @Override
    public Map<String, Object> processQueryURL(String URL) {
        FileScanReport urlInformation;
        Map<String, Object> result = new HashMap<>();

        result.put("url", URL);

        try {
            String[] urls = new String[]{URL};
            urlInformation = virusTotalRef.getUrlScanReport(urls, false)[0];
            log.trace("Petition completed with code {}", urlInformation.getResponseCode());

            if (urlInformation.getResponseCode() != 0)
                result.put("score", (urlInformation.getPositives() * 100 / urlInformation.getTotal()));
            else
                result.put("score", -1);

        } catch (Exception e) {
            log.error(e.getLocalizedMessage());
            result.put("score", -1);
        }

        return result;
    }

    @Override
    public Map<String, Object> processQueryHash(String hash) {

        FileScanReport scanInformation;
        Map<String, Object> result = new HashMap<>();

        result.put("hash", hash);

        try {

            scanInformation = virusTotalRef.getScanReport(hash);
            log.trace("Petition for hash completed with code : {}", scanInformation.getResponseCode());

            if (scanInformation.getResponseCode() != 0)
                result.put("score", (scanInformation.getPositives() * 100 / scanInformation.getTotal()));
            else
                result.put("score", -1);

        } catch (IOException e) {
            log.error(e.getLocalizedMessage());
            result.put("score", -1);
        } catch (UnauthorizedAccessException e) {
            log.error(e.getLocalizedMessage());
            result.put("score", -1);
        } catch (QuotaExceededException e) {
            log.error(e.getLocalizedMessage());
            result.put("score", -1);
        }

        return result;
    }

    @Override
    public Map<String, Object> processQueryIP(String IP) {

        IPAddressReport ipInformation;
        Map<String, Object> result = new HashMap<>();

        result.put("ip", IP);
        if(IPUtils.isPrivateNetwork(IP)){
            log.info("Requesting to private IP, returning with code 0");
            result.put("score", 0);
            return result;
        }
        try {
            ipInformation = virusTotalRef.getIPAddresReport(IP);
            log.info("Petition for IP completed with code : {}", ipInformation.getResponseCode());
            if (ipInformation.getResponseCode() != 0){
                int score = 0;
                URL[] urls = ipInformation.getDetectedUrls();
                if(urls.length > 0){
                    score = urls[0].getPositives() * 100 / urls[0].getTotal();
                }
                log.info("Got IP score from VirusTotal {}", score);
                result.put("score", score);
            } else {
                result.put("score", -1);
            }
        } catch (InvalidArguentsException e) {
            log.error(e.getLocalizedMessage());
            result.put("score", -1);
        } catch (QuotaExceededException e) {
            log.error(e.getLocalizedMessage());
            result.put("score", -1);
        } catch (UnauthorizedAccessException e) {
            log.error(e.getLocalizedMessage());
            result.put("score", -1);
        } catch (IOException e) {
            log.error(e.getLocalizedMessage());
            result.put("score", -1);
        }

        return result;
    }
}
