package net.redborder.malware.tasks.timertask;

import com.aerospike.client.AerospikeClient;
import net.redborder.malware.managers.AeroSpikeManager;
import net.redborder.malware.tasks.executortask.ConsumeMessages;
import org.apache.curator.utils.ZKPaths;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Map;
import java.util.TimerTask;

public class QueryTimerTask extends TimerTask {

    private static QueryTimerTask INSTANCE = null;

    private static int OFFSET = 2;

    private static AeroSpikeManager asm = null;

    private static ArrayList<Map<String, Object>> total = new ArrayList<>();;

    private static Map<String, ArrayList<Map<String, Object>>> mapeoRevisiones = new HashMap<>();

    private static int revision = 0;

    public static QueryTimerTask getInstance(){
        if(INSTANCE == null)
            INSTANCE = new QueryTimerTask();

        return INSTANCE;
    }

    public static void setClientAerospark(AeroSpikeManager a){
        asm = a;
    }

    public static void setOffset(int offset){
        OFFSET = offset;
    }

    @Override
    public void run() {

        System.out.println("Created/Update total");
        total = queryTotal();

        if (mapeoRevisiones.isEmpty()) {
            mapeoRevisiones.put(String.format("rev_%d", revision), ConsumeMessages.getRevision());
        } else {
            ConsumeMessages.newRevision();
            revision++;
            mapeoRevisiones.put(String.format("rev_%d", revision), ConsumeMessages.getRevision());
        }

        System.out.println("Created revision : " + revision);

        if (mapeoRevisiones.size() > OFFSET) {
            System.out.println("Deleted revision : " + (revision - OFFSET));
            mapeoRevisiones.remove(String.format("rev_%d", revision - OFFSET));
        }

    }

    private ArrayList<Map<String, Object>> queryTotal() {

        ArrayList<Map<String, Object>> total = asm.getList("malware", "rb_malware");

        for (Map<String, Object> m : total) {
            m.remove("cuckoo_before");
            m.put("action", "create");
        }

        return total;
    }

    public static ArrayList<Map<String, Object>> getRevNum(int numRev) {
        String key = String.format("rev_%d", numRev);
        return mapeoRevisiones.containsKey(key) ? mapeoRevisiones.get(key) : null;
    }

    public static ArrayList<Map<String, Object>> getTotal() {
        return total;
    }

    public static int getCurrentRevision() {
        return revision;
    }

}
