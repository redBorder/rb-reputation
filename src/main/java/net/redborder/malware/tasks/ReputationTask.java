package net.redborder.malware.tasks;

import net.redborder.malware.MalwareREST;
import net.redborder.malware.config.Config;
import net.redborder.malware.controllers.MalwareDataModuleController;
import net.redborder.malware.modules.data.DataModule;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import spark.Session;

import java.util.Map;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.PriorityBlockingQueue;

public class ReputationTask extends AbstractTask {

    private static final Logger log = LoggerFactory.getLogger(ReputationTask.class);

    // Data Module
    private MalwareDataModuleController dataModuleController;

    // Queues
    private PriorityBlockingQueue<Object> priorityBlockingQueue;

    public ReputationTask(Config confDataModule, Config confOutputModule, PriorityBlockingQueue<Object> priorityBlockingQueue) {

        dataModuleController = new MalwareDataModuleController(confDataModule);

        this.priorityBlockingQueue = priorityBlockingQueue;

        dataModuleController.init();
    }

    @Override
    protected Object doTaskImpl(TaskMonitor monitor) {

        try {

            Session session;

            while ((session = (Session)this.priorityBlockingQueue.take()) != null) {
                log.trace("Getting new petition ...");

                CountDownLatch latch = session.attribute("latch");

                MalwareREST.OPERATION operation = session.attribute(MalwareREST.PARAM_API_OPERATION);
                MalwareREST.PROCESS process = session.attribute(MalwareREST.PARAM_QUERY_PROCESS);
                MalwareREST.RESPONSE response = session.attribute(MalwareREST.PARAM_QUERY_RESPONSE);
                DataModule.FullDataType fullDataType = session.attribute(MalwareREST.PARAM_FULLDATA_TYPE);


                if(process != null)
                    dataModuleController.setProcess(process);
                else
                    dataModuleController.setProcess(MalwareREST.PROCESS.AGILE);

                log.trace("Set process to : {}", process);

                if(response != null)
                    dataModuleController.setResponse(response);
                else
                    dataModuleController.setResponse(MalwareREST.RESPONSE.SIMPLE);

                log.trace("Set response to : {}", response);

                switch (operation){
                    case QUERY:
                        log.info("Doing query ... ");
                        Map<String, Object> query = session.attribute("query");
                        session.attribute("finalResult", dataModuleController.doQuery(query));
                        break;
                    case TOTAL:
                        log.info("Doing total ... ");
                        session.attribute("finalResult", dataModuleController.getFullData(fullDataType));
                        break;
                    case INCREMENTAL:
                        //None
                        break;
                }

                log.trace("Petition completed!");

                latch.countDown();

            }

        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        return null;
    }

    @Override
    protected void shutdownImpl() {
        log.info("Shutting down reputation");
        dataModuleController.shutdown();
        log.info("Shutdown!");
    }

    @Override
    public Class<?> getTaskResultType() {
        return null;
    }

    @Override
    public void reload() {
        dataModuleController.reload();
    }

}
